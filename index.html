<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>é‹å–¶ã‚¹ã‚­ãƒ£ãƒŠ</title>

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- ZXing: UMDãƒ“ãƒ«ãƒ‰ -->
<script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", system-ui, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 1.5rem;
    color: #1a1a1a;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
  }

  h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    text-align: center;
    margin-bottom: 2rem;
    letter-spacing: -0.02em;
  }

  /* Liquid Glass Card */
  .glass-card {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Camera Section */
  .camera-section {
    text-align: center;
  }

  #video {
    width: 100%;
    max-width: 500px;
    height: auto;
    aspect-ratio: 4/3;
    border-radius: 16px;
    background: #000;
    margin: 1rem auto;
    display: block;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
  }

  /* Fullscreen Camera Overlay */
  .camera-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 1000;
    flex-direction: column;
  }

  .camera-overlay.active {
    display: flex;
  }

  .camera-overlay #video {
    width: 100%;
    height: 100%;
    max-width: none;
    border-radius: 0;
    margin: 0;
    object-fit: cover;
  }

  .camera-close-btn {
    position: absolute;
    top: 2rem;
    right: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.5);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .camera-close-btn:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
  }

  .camera-status {
    position: absolute;
    bottom: 3rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(20px);
    padding: 1rem 2rem;
    border-radius: 16px;
    color: white;
    font-size: 1rem;
    text-align: center;
    z-index: 1001;
  }

  /* Result Modal Popup */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
  }

  .modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(40px) saturate(180%);
    border-radius: 28px;
    padding: 2.5rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.8);
    position: relative;
    animation: slideUp 0.4s ease;
    color: #1a1a1a;
  }

  @keyframes slideUp {
    from { 
      opacity: 0; 
      transform: translateY(30px) scale(0.95);
    }
    to { 
      opacity: 1; 
      transform: translateY(0) scale(1);
    }
  }

  .modal-close-btn {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.1);
    border: none;
    color: #666;
    font-size: 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .modal-close-btn:hover {
    background: rgba(0, 0, 0, 0.2);
    transform: scale(1.1);
  }

  .modal-badge {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .modal-badge-pre {
    background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(52, 199, 89, 0.4);
  }

  .modal-badge-onsite {
    background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
  }

  .modal-user-name {
    font-size: 2.25rem;
    font-weight: 800;
    color: #1a1a1a;
    margin-bottom: 1.5rem;
    letter-spacing: -0.03em;
    line-height: 1.2;
  }

  .modal-user-info {
    font-size: 1.35rem;
    color: #333;
    margin-bottom: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-user-meta {
    font-size: 0.8rem;
    color: #999;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid rgba(0, 0, 0, 0.1);
    font-family: 'SF Mono', Monaco, monospace;
    line-height: 1.8;
  }

  /* Buttons */
  .button-group {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  button {
    flex: 1;
    min-width: 140px;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    backdrop-filter: blur(10px);
  }

  #start-scan {
    background: rgba(52, 199, 89, 0.9);
    color: white;
    box-shadow: 0 4px 16px rgba(52, 199, 89, 0.4);
  }

  #start-scan:hover:not(:disabled) {
    background: rgba(52, 199, 89, 1);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 199, 89, 0.5);
  }

  #stop-scan {
    background: rgba(255, 59, 48, 0.9);
    color: white;
    box-shadow: 0 4px 16px rgba(255, 59, 48, 0.4);
  }

  #stop-scan:hover:not(:disabled) {
    background: rgba(255, 59, 48, 1);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 59, 48, 0.5);
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Manual Input Section */
  .input-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  #uuid-input {
    flex: 1;
    min-width: 200px;
    padding: 0.875rem 1rem;
    font-size: 0.95rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-family: 'SF Mono', Monaco, monospace;
    backdrop-filter: blur(10px);
  }

  #uuid-input::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  #uuid-input:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.25);
  }

  #lookup-btn {
    background: rgba(0, 122, 255, 0.9);
    color: white;
    padding: 0.875rem 1.5rem;
    box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
  }

  #lookup-btn:hover {
    background: rgba(0, 122, 255, 1);
    transform: translateY(-2px);
  }

  /* Result Display */
  .result-section {
    min-height: 200px;
  }

  .result-section h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: white;
    margin-bottom: 1rem;
    letter-spacing: -0.01em;
  }

  #result {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 1.5rem;
    font-size: 0.95rem;
    color: white;
    line-height: 1.6;
    white-space: pre-wrap;
    min-height: 150px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* Result Content Styling */
  .result-content {
    display: none;
  }

  .result-content.active {
    display: block;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .badge-pre {
    background: rgba(52, 199, 89, 0.3);
    color: #34c759;
    border: 2px solid rgba(52, 199, 89, 0.5);
  }

  .badge-onsite {
    background: rgba(0, 122, 255, 0.3);
    color: #007aff;
    border: 2px solid rgba(0, 122, 255, 0.5);
  }

  .user-name {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
  }

  .user-info {
    font-size: 1.25rem;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .user-meta {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-family: 'SF Mono', Monaco, monospace;
  }

  .divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.2);
    margin: 1.5rem 0;
  }

  @media (max-width: 480px) {
    body {
      padding: 1rem;
    }

    h1 {
      font-size: 1.5rem;
    }

    .button-group {
      flex-direction: column;
    }

    button {
      width: 100%;
    }

    .user-name {
      font-size: 1.5rem;
    }

    .user-info {
      font-size: 1.1rem;
    }
  }
</style>
</head>

<body>
  <div class="container">
    <h1>åŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹ å—ä»˜</h1>

    <div id="login-section" class="glass-card">
      <h2>é‹å–¶ã‚¹ã‚¿ãƒƒãƒ• ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <form id="login-form" class="space-y-4 mt-4">
        <div>
          <label for="login-email" class="block text-sm font-medium text-white/80">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="login-email" required class="input-group #uuid-input w-full" placeholder="staff@example.com">
        </div>
        <div>
          <label for="login-password" class="block text-sm font-medium text-white/80">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="login-password" required class="input-group #uuid-input w-full" placeholder="********">
           <p class="text-xs text-white/60 mt-1">â€»ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        <button type="submit" id="login-btn" class="button-group #start-scan w-full">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p id="login-error" class="text-red-400 text-sm mt-2"></p>
      </form>
    </div>
    <div id="scanner-section" style="display: none;">
        <div class="glass-card camera-section">
          <div class="button-group">
            <button id="start-scan">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
            <button id="stop-scan" disabled>â¹ åœæ­¢</button>
            <button id="logout-btn" class=" #stop-scan">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button> </div>
        </div>

        <div class="glass-card">
          <div class="input-group">
            <input id="uuid-input" placeholder="UUIDæ‰‹å…¥åŠ›ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰" />
            <button id="lookup-btn">æ¤œç´¢</button>
          </div>
        </div>

        <div class="glass-card result-section">
          <h2>æœ€è¿‘ã®ã‚¹ã‚­ãƒ£ãƒ³</h2>
          <div id="result">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
        </div>
    </div>
    </div>

  <!-- Fullscreen Camera Overlay -->
  <div class="camera-overlay" id="camera-overlay">
    <button class="camera-close-btn" id="camera-close">âœ•</button>
    <video id="video" autoplay playsinline muted></video>
    <div class="camera-status" id="camera-status">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«ã‹ã–ã—ã¦ãã ã•ã„</div>
  </div>

  <!-- Result Modal Popup -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" id="modal-close">âœ•</button>
      <div id="modal-result"></div>
    </div>
  </div>

<script>
/** Supabaseæ¥ç¶š */
const SUPABASE_URL = "https://fsaeuowdijoeqhnrqazx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzYWV1b3dkaWpvZXFobnJxYXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjA0MjYsImV4cCI6MjA3NTQ5NjQyNn0.xgIQ9jf3qa4oy6Dbc8mVaP8woRDWBwMxLAJwiCGEWmk";
// â˜… åˆæœŸçŠ¶æ…‹ã§ã¯ Anon ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦åˆæœŸåŒ–
let sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
     auth: { persistSession: false } // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æ‰‹å‹•ç®¡ç†
});

// â˜… ãƒ­ã‚°ã‚¤ãƒ³å¾Œã« JWT ã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
function initializeSupabaseClient(jwt = null) {
    const headers = {};
    if (jwt) {
        headers['Authorization'] = `Bearer ${jwt}`;
    }
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        global: { headers: headers },
        auth: { persistSession: false }
    });
    console.log("Supabase client re-initialized.", jwt ? "with JWT" : "without JWT");
}
// ç”»é¢è¦ç´ 
const els = {
 // --- ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ ---
  loginSection: document.getElementById('login-section'),
  loginForm: document.getElementById('login-form'),
  loginEmail: document.getElementById('login-email'),
  loginPassword: document.getElementById('login-password'), // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ãƒ¡ã‚¢ãƒ‰ã‚’ä½¿ç”¨
  loginBtn: document.getElementById('login-btn'),
  loginError: document.getElementById('login-error'),
  // --- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–¢é€£ ---
  scannerSection: document.getElementById('scanner-section'), // å…¨ä½“ã‚’å›²ã‚€div
  logoutBtn: document.getElementById('logout-btn'), // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
  start: document.getElementById('start-scan'),
  stop: document.getElementById('stop-scan'),
  video: document.getElementById('video'),
  result: document.getElementById('result'),
  uuidInput: document.getElementById('uuid-input'),
  lookupBtn: document.getElementById('lookup-btn'),
  cameraOverlay: document.getElementById('camera-overlay'),
  cameraClose: document.getElementById('camera-close'),
  cameraStatus: document.getElementById('camera-status'),
  modalOverlay: document.getElementById('modal-overlay'),
  modalResult: document.getElementById('modal-result'),
  modalClose: document.getElementById('modal-close')
};

function setResult(html) {
  els.result.innerHTML = html;
}

function setCameraStatus(text) {
  els.cameraStatus.textContent = text;
}

function showModal(html) {
  els.modalResult.innerHTML = html;
  els.modalOverlay.classList.add('active');
}

function hideModal() {
  els.modalOverlay.classList.remove('active');
}

function formatModalResult(data) {
  const badgeClass = data.registration_type === 'pre_registration' ? 'modal-badge-pre' : 'modal-badge-onsite';
  const badgeText = data.registration_type === 'pre_registration' ? 'âœ… äº‹å‰ç™»éŒ²æ¸ˆã¿' : 'ğŸŸ¦ å½“æ—¥å—ä»˜';
  
  return `
    <div class="modal-badge ${badgeClass}">${badgeText}</div>
    <div class="modal-user-name">${data.name || '-'}</div>
    <div class="modal-user-info">ğŸ« ${data.school || '-'}</div>
    <div class="modal-user-info">ğŸ“š ${data.department || '-'}</div>
    <div class="modal-user-meta">
      UUID: ${data.id}<br>
      ç™»éŒ²åŒºåˆ†: ${data.registration_type || '-'}
    </div>
  `;
}

function formatResult(data) {
  const badgeClass = data.registration_type === 'pre_registration' ? 'badge-pre' : 'badge-onsite';
  const badgeText = data.registration_type === 'pre_registration' ? 'âœ… äº‹å‰ç™»éŒ²' : 'ğŸŸ¦ å½“æ—¥å—ä»˜';
  
  return `
    <div class="badge ${badgeClass}">${badgeText}</div>
    <div class="user-name">${data.name || '-'}</div>
    <div class="user-info">ğŸ« ${data.school || '-'}</div>
    <div class="user-info">ğŸ“š ${data.department || '-'}</div>
  `;
}

// --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
async function handleLogin(event) {
    event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡ã‚’é˜²ã
    els.loginError.textContent = '';
    els.loginBtn.disabled = true;
    els.loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

    const email = els.loginEmail.value.trim();
    const password = els.loginPassword.value.trim(); // ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ãƒ¡ã‚¢ãƒ‰ã¨åŒã˜)

    if (!email || !password) {
        els.loginError.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        els.loginBtn.disabled = false;
        els.loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        return;
    }

    try {
        // â˜… Supabase Auth ã‚’ä½¿ã£ãŸãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å‘¼ã³å‡ºã™ (login ã‚¨ãƒƒã‚¸é–¢æ•°ã¯ä¸è¦ã«)
        const { data, error } = await sb.auth.signInWithPassword({
            email: email,
            password: password,
        });

        if (error) {
            console.error("Login Error:", error);
            if (error.message.includes('Invalid login credentials')) {
                els.loginError.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
            } else {
                 els.loginError.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
            throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦ catch ã§å‡¦ç†
        }

        if (data.session && data.user) {
            console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:", data.user.email);
            const jwt = data.session.access_token;
            localStorage.setItem('scanner_auth_token', jwt); // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
            localStorage.setItem('scanner_user_email', data.user.email); // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ä¿å­˜ï¼ˆä»»æ„ï¼‰

            initializeSupabaseClient(jwt); // â˜… JWTã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†åˆæœŸåŒ–
            showScannerUI(); // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”»é¢ã‚’è¡¨ç¤º
        } else {
            throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        }

    } catch (error) {
        // ã‚¨ãƒ©ãƒ¼å‡¦ç† (ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ try ãƒ–ãƒ­ãƒƒã‚¯å†…ã§è¨­å®šæ¸ˆã¿)
        els.loginBtn.disabled = false;
        els.loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
    }
}

// --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ---
function handleLogout() {
    localStorage.removeItem('scanner_auth_token');
    localStorage.removeItem('scanner_user_email');
    initializeSupabaseClient(); // ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†åˆæœŸåŒ–
    showLoginUI(); // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
    stopZXing(); //å¿µã®ãŸã‚ã‚«ãƒ¡ãƒ©ã‚‚åœæ­¢
    console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
}

// --- UIè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ---
function showLoginUI() {
    els.loginSection.style.display = 'block';
    els.scannerSection.style.display = 'none';
    els.loginPassword.value = ''; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¬„ã‚¯ãƒªã‚¢
}

function showScannerUI() {
    els.loginSection.style.display = 'none';
    els.scannerSection.style.display = 'block';
    els.loginError.textContent = ''; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
    els.loginBtn.disabled = false;   // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    els.loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
}
 
// Supabase RPC: uuid â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
async function lookupByUuid(id, showInModal = false) {
  setCameraStatus('ğŸ” ç…§ä¼šä¸­â€¦');
  setResult('ğŸ” ç…§ä¼šä¸­â€¦');
  try {
    const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!uuidRe.test(id)) throw new Error('UUIDå½¢å¼ãŒä¸æ­£ã§ã™');

    const { data, error } = await sb.rpc('lookup_user', { p_id: id }).single();
    if (error) throw error;

    if (!data) {
      const errorMsg = 'âŒ è©²å½“ãªã—<br><span style="font-size:0.9rem;opacity:0.8;">ã“ã®UUIDã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</span>';
      if (showInModal) {
        showModal(errorMsg);
      } else {
        setResult(errorMsg);
      }
      return;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    if (showInModal) {
      showModal(formatModalResult(data));
    }
    
    // å±¥æ­´ã¨ã—ã¦ä¸‹éƒ¨ã«ã‚‚è¡¨ç¤º
    setResult(formatResult(data));
    
  } catch (e) {
    const errorMsg = 'âš ï¸ ã‚¨ãƒ©ãƒ¼<br><span style="font-size:0.9rem;opacity:0.8;">' + (e.message || String(e)) + '</span>';
    if (showInModal) {
      showModal(errorMsg);
    } else {
      setResult(errorMsg);
    }
  }
}

/* ZXing ã‚¹ã‚­ãƒ£ãƒŠ */
let codeReader = null;
let currentDeviceId = null;

async function pickBackCamera(devices) {
  const byLabel = devices.find(d =>
    /back|rear|environment|å¾Œé¢|èƒŒé¢/i.test(d.label || '')
  );
  if (byLabel) return byLabel.deviceId;
  return devices.length ? devices[devices.length - 1].deviceId : null;
}

async function startZXing() {
  els.cameraOverlay.classList.add('active');
  setCameraStatus('ğŸ“· åˆæœŸåŒ–ä¸­â€¦');
  try {
    if (!window.ZXing || !window.ZXing.BrowserMultiFormatReader) {
      throw new Error('ZXing ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
    const devices = await codeReader.listVideoInputDevices();
    if (!devices || devices.length === 0) {
      setCameraStatus('âŒ ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    currentDeviceId = await pickBackCamera(devices);

    els.start.disabled = true;
    els.stop.disabled = false;

    await codeReader.decodeFromVideoDevice(
      currentDeviceId,
      els.video,
      async (result, err) => {
        if (result) {
          const text = (result.getText() || '').trim();
          await lookupByUuid(text, true); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          stopZXing();
        } else if (err && !(err instanceof ZXing.NotFoundException)) {
          setCameraStatus('âš ï¸ èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼');
        }
      }
    );

    els.video.setAttribute('playsinline', 'true');
    els.video.muted = true;

    setCameraStatus('ğŸ‘€ QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«ã‹ã–ã—ã¦ãã ã•ã„');
  } catch (e) {
    setCameraStatus('âš ï¸ åˆæœŸåŒ–å¤±æ•—: ' + (e.message || String(e)));
  }
}

function stopZXing() {
  try { if (codeReader) codeReader.reset(); } catch {}
  els.start.disabled = false;
  els.stop.disabled = true;
  const stream = els.video.srcObject;
  if (stream && stream.getTracks) stream.getTracks().forEach(t => t.stop());
  els.video.srcObject = null;
  els.cameraOverlay.classList.remove('active');
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
els.loginForm.addEventListener('submit', handleLogin); // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
els.logoutBtn.addEventListener('click', handleLogout); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³

els.start.addEventListener('click', startZXing);
els.stop.addEventListener('click', stopZXing);
els.cameraClose.addEventListener('click', stopZXing);
els.modalClose.addEventListener('click', hideModal);
els.modalOverlay.addEventListener('click', (e) => {
  if (e.target === els.modalOverlay) hideModal();
});
els.lookupBtn.addEventListener('click', () => {
  const id = (els.uuidInput.value || '').trim();
  if (!id) return;
  lookupByUuid(id, true); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
});

// --- åˆæœŸåŒ–å‡¦ç† ---
function initializeApp() {
    const token = localStorage.getItem('scanner_auth_token');
    if (token) {
        console.log("æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚");
        // â˜… ã“ã“ã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã‹æ¤œè¨¼ã™ã‚‹ã®ãŒç†æƒ³ (ä¾‹: getUser ã‚’è©¦ã™)
        // ä»Šå›ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã¨ã¿ãªã™
        initializeSupabaseClient(token);
        showScannerUI();
    } else {
        console.log("ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
        initializeSupabaseClient(); // ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§åˆæœŸåŒ–
        showLoginUI();
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
initializeApp();

</script>
</body>
</html>
