<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>運営スキャナ（事前登録チェック）</title>

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- ZXing (モバイル対応のQRデコード) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>

<body>
  <h1>運営スキャナ（事前登録チェック）</h1>

  <section>
    <button id="start-scan">📷 カメラでQRスキャン開始</button>
    <button id="stop-scan" disabled>⏹ 停止</button>
    <div style="margin-top:.5rem;">
      <video id="video" autoplay playsinline muted style="width: 320px; height: 240px; background:#000;"></video>
    </div>
  </section>

  <section style="margin-top:1rem;">
    <div>
      手入力テスト: <input id="uuid-input" placeholder="ユーザーUUIDを貼り付け" size="50" />
      <button id="lookup-btn">照会</button>
    </div>
  </section>

  <hr />

  <section>
    <h2>結果</h2>
    <pre id="result" style="white-space:pre-wrap;"></pre>
  </section>

<script>
/** ▼ Supabase接続（あなたのプロジェクトの値） ▼ */
const SUPABASE_URL = "https://fsaeuowdijoeqhnrqazx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzYWV1b3dkaWpvZXFobnJxYXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjA0MjYsImV4cCI6MjA3NTQ5NjQyNn0.xgIQ9jf3qa4oy6Dbc8mVaP8woRDWBwMxLAJwiCGEWmk";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false }});
/** ▲ ここまで ▲ */

// 画面要素
const els = {
  start: document.getElementById('start-scan'),
  stop: document.getElementById('stop-scan'),
  video: document.getElementById('video'),
  result: document.getElementById('result'),
  uuidInput: document.getElementById('uuid-input'),
  lookupBtn: document.getElementById('lookup-btn')
};

function setResult(text) {
  els.result.textContent = text;
}

function badge(regType) {
  if (!regType) return "";
  if (regType === 'pre_registration') return '［✅ 事前登録済み］';
  if (regType === 'on_site') return '［🟦 当日受付］';
  return `［${regType}］`;
}

// Supabase RPC: uuid → ユーザー情報
async function lookupByUuid(id) {
  setResult('照会中…');
  try {
    // UUIDフォーマット軽チェック
    const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!uuidRe.test(id)) throw new Error('UUID形式が不正です');

    const { data, error } = await sb.rpc('lookup_user', { p_id: id }).single();
    if (error) throw error;

    if (!data) {
      setResult('該当なし（UUIDが見つかりません）');
      return;
    }

    const lines = [
      `${badge(data.registration_type)}  UUID: ${data.id}`,
      `氏名: ${data.name || '-'}`,
      `学校: ${data.school || '-'}`,
      `学部/学科: ${data.department || '-'}`,
      `登録区分: ${data.registration_type || '-'}`
    ];
    setResult(lines.join('\n'));
  } catch (e) {
    setResult('エラー: ' + (e.message || String(e)));
  }
}

/* ===== ZXing を使ったモバイル対応スキャナ ===== */
let codeReader = null;
let currentDeviceId = null;

async function pickBackCamera(devices) {
  // 背面らしいラベルを優先
  const byLabel = devices.find(d =>
    /back|rear|environment|後面|背面/i.test(d.label || '')
  );
  if (byLabel) return byLabel.deviceId;
  // 次点: 多くの端末で背面が最後
  return devices.length ? devices[devices.length - 1].deviceId : null;
}

async function startZXing() {
  setResult('初期化中…（カメラ権限を許可してください）');
  try {
    if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
    const devices = await codeReader.listVideoInputDevices();
    if (!devices || devices.length === 0) {
      setResult('カメラが見つかりません（HTTPS/権限を確認）');
      return;
    }
    currentDeviceId = await pickBackCamera(devices);

    els.start.disabled = true;
    els.stop.disabled = false;

    await codeReader.decodeFromVideoDevice(
      currentDeviceId,
      els.video,
      async (result, err) => {
        if (result) {
          const text = (result.getText() || '').trim();
          await lookupByUuid(text);
          stopZXing(); // 1回読んだら停止
        } else if (err && !(err instanceof ZXing.NotFoundException)) {
          els.result.textContent = '読み取りエラー: ' + (err.message || String(err));
        }
      }
    );

    // iOSのインライン再生対策
    els.video.setAttribute('playsinline', 'true');
    els.video.muted = true;

    setResult('スキャン待機中… QRをかざしてください');
  } catch (e) {
    setResult('初期化失敗: ' + (e.message || String(e)));
  }
}

function stopZXing() {
  try { if (codeReader) codeReader.reset(); } catch {}
  els.start.disabled = false;
  els.stop.disabled = true;
  const stream = els.video.srcObject;
  if (stream && stream.getTracks) stream.getTracks().forEach(t => t.stop());
  els.video.srcObject = null;
}

// イベント
els.start.addEventListener('click', startZXing);
els.stop.addEventListener('click', stopZXing);
els.lookupBtn.addEventListener('click', () => {
  const id = (els.uuidInput.value || '').trim();
  if (!id) return;
  lookupByUuid(id);
});
</script>
</body>
</html>
